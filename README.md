# Nance Chat
ğŸ”°p2pğŸ”° <= åˆå¿ƒè€…ã§ã™
## æ¦‚è¦
Nance Chatã¯ã€ãƒ”ã‚¢ãƒ„ãƒ¼ãƒ”ã‚¢ï¼ˆP2Pï¼‰ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€UDP hole punchingã‚’ä½¿ã„ã¾ã™ãŒã€NATã®çŠ¶æ³ã‚ˆã£ã¦ã¯NATè¶…ãˆãŒã§ããªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚ï¼ˆãã®å ´åˆã¯ã‚µãƒ¼ãƒã¨ã—ã¦ã¯å‹•ãã¾ã›ã‚“ã€‚ï¼‰

ã“ã®Nance Chatã¯ä¸€æ—¥ãŠãã«ã™ã¹ã¦ã®ãƒãƒ£ãƒƒãƒˆã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¶ˆãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ èµ·å‹•æ™‚ã‹ã‚‰ã®æ™‚é–“ï¼‰

## ãƒ”ã‚¢ã®ç¨®é¡
é€šå¸¸ã®ãƒ”ã‚¢ã¨ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ”ã‚¢ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ”ã‚¢ã¯åŸºæœ¬çš„ã«èª°ã‹ãŒæœ€åˆã«ãƒ”ã‚¢ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®ãƒ”ã‚¢ã§ã™ã€‚
ãƒ”ã‚¢ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ãªã®ã§ã€ãƒãƒ£ãƒƒãƒˆã®æ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãã—ã¦ã€ãƒãƒ¼ãƒˆã‚’å¸¸ã«é–‹æ”¾ã—ã¦ã„ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

## æ©Ÿèƒ½
- **P2Pé€šä¿¡**:ä¸­å¤®ã‚µãƒ¼ãƒãƒ¼ã‚’å¿…è¦ã¨ã›ãšã€ãƒ”ã‚¢é–“ã§ç›´æ¥é€šä¿¡ãŒå¯èƒ½ã§ã™ã€‚
- **ãƒãƒ£ãƒƒãƒˆç®¡ç†**:ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã€ç®¡ç†ã§ãã¾ã™ã€‚
- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†**:ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
Nance Chatã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€Python 3.xãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ï¼š

```bash
pip install flask requests pyyaml stun
```

## ä½¿ç”¨æ–¹æ³•
1. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•**:ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã¨Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’èµ·å‹•ã—ã¾ã™ã€‚(ã“ã®æ™‚ã«ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã‚µãƒ¼ãƒãƒ¼ã®IPãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§ã€äº‹å‰ã«çŸ¥ã£ã¦ãŠã„ã¦ãã ã•ã„)
   ```bash
   python src/nancePeer.py
   ```

2. **Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹**:Webãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ãã€`http://localhost:8080`ã«ç§»å‹•ã—ã¦ãƒãƒ£ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

3. **æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã®ä½œæˆ**:Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é–‹å§‹ã—ã¾ã™ã€‚
## ãƒ—ãƒ­ãƒˆã‚³ãƒ«
### ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º
- ä¸€ã¤ã®é€šä¿¡ã¯1MBã¾ã§ã§ã™ã€‚ï¼ˆbase64ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸã¨ãã®ã‚µã‚¤ã‚ºï¼‰
### é©ç”¨ã•ã‚Œã‚‹ã™ã¹ã¦
ãƒ”ã‚¢ã‚„ãƒãƒ¼ãƒ‰ã¨ã®é€šä¿¡ã§ã¯ã€UDPã§ã€UTF-8æ–‡å­—åˆ—ã®è¾æ›¸å‹ãƒ‡ãƒ¼ã‚¿ã‚’Base64ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸãƒã‚¤ãƒˆé…åˆ—ã¾ãŸã¯æ–‡å­—åˆ—ãŒé€å—ä¿¡ã•ã‚Œã¾ã™ã€‚é€ä¿¡ã•ã‚Œã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®è©³ç´°ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
*æ³¨æ„:å¤§æ–‡å­—ã¨å°æ–‡å­—ã®åŒºåˆ¥ãŒé‡è¦ã§ã™ã€‚*
```json
{
    "m":"Mode(p,r,c,s,R)",
    // æ¬¡ã®éƒ¨åˆ†ã¯ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™
    "z":"ãƒªã‚¯ã‚¨ã‚¹ãƒˆè­˜åˆ¥å­ï¼ˆä»»æ„ï¼‰"
}
```

### p(ping)
ä»–ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¨ã®æ¥ç¶šã‚’ç¢ºèªã—ã¾ã™ã€‚
```json
{
    "m":"p"
}
```

### r(request)
å–å¾—ã¾ãŸã¯ç™»éŒ²ã®ãŸã‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™ã€‚
```json
{
    "m":"r",
    "t":"Request Type(g,r)",
    "d":"Content Type(c,p,i)",
    "a":{
        // å¼•æ•°ï¼ˆå†…å®¹ã«ã‚ˆã£ã¦ç•°ãªã‚‹ï¼‰
    }
}
```

#### g(get)
ä»–ã®ãƒ”ã‚¢ã¾ãŸã¯ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ”ã‚¢ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚

##### c(chats)
ãƒãƒ£ãƒƒãƒˆã®ãƒªã‚¹ãƒˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™ï¼ˆãƒãƒ£ãƒƒãƒˆåã¯å«ã¾ã‚Œã¾ã›ã‚“ï¼‰ã€‚
```json
{
    "m":"r",
    "t":"g",
    "d":"c",
    "a":{
        "maxChatsLength":"å—ä¿¡å¯èƒ½ãªãƒãƒ£ãƒƒãƒˆã®é•·ã•"
    }
}
```

##### m(messages)
ãƒãƒ£ãƒƒãƒˆå†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™ï¼ˆãƒãƒ£ãƒƒãƒˆåã¯å«ã¾ã‚Œã¾ã›ã‚“ï¼‰ã€‚
```json
{
    "m":"r",
    "t":"g",
    "d":"m",
    "a":{
        "chatUuid":"ãƒãƒ£ãƒƒãƒˆUUID"
    }
}
```

##### i(information)
ä»–ã®ãƒ”ã‚¢ã¾ãŸã¯ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ”ã‚¢ã‹ã‚‰ãƒ”ã‚¢æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚
```json
{
    "m":"g",
    "t":"r",
    "d":"i",
    "a":{
        "maxPeersLength":"å—ä¿¡å¯èƒ½ãªãƒ”ã‚¢ã®é•·ã•"
    }
}
```
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è­˜åˆ¥å­ï¼ˆnï¼‰ã¯ã€äº‹å‰ã«ãã®ãƒãƒ£ãƒƒãƒˆã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯IDã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### r(register)
è‡ªåˆ†ã®æƒ…å ±ã‚’ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ”ã‚¢ã«ç™»éŒ²ã—ã¾ã™ã€‚

##### i(information)
ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ”ã‚¢ã¾ãŸã¯ãƒ”ã‚¢ã«ãƒ”ã‚¢æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
ã“ã‚Œã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å‚åŠ ã™ã‚‹ãŸã‚ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ï¼
```json
{
    "m":"r",
    "t":"r",
    "d":"i",
    "a":{
        "natConeType":"NATçŠ¶æ…‹ï¼ˆæ–‡å­—åˆ—ï¼‰ï¼ˆRestricted Coneã¾ãŸã¯Full Coneï¼‰",
    }
}
```

#### s(send)
ç™»éŒ²ã¨ã¯å°‘ã—ç•°ãªã‚Šã¾ã™ãŒã€è»½ã„æƒ…å ±ã®ç™»éŒ²ã§ã™ã€‚

##### m(message)
```json
{
    "m":"r",
    "t":"s",
    "d":"m",
    "a":{
        "chatUuid":"ãƒãƒ£ãƒƒãƒˆUUID",
        "name":"ãƒãƒ£ãƒƒãƒˆä½œæˆè€…ã®åå‰",
        "content":"ãƒãƒ£ãƒƒãƒˆå†…å®¹"
    }
}
```

### R(response)
ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚ŒãŸã¨ãã«è¿”ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã™ã€‚
```json
{
    "m":"R",
    "r":"çµæœï¼ˆæ•´æ•°ã€æˆåŠŸã®å ´åˆã¯0ã€ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãã‚Œä»¥å¤–ï¼‰",
    "c":{
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹
    }
}
```

#### çµæœãŒ0ã®å ´åˆ
çµæœãŒ0ã®å ´åˆã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæˆåŠŸã—ãŸã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚

##### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹
- ãƒãƒ£ãƒƒãƒˆãƒªã‚¹ãƒˆ
    ```json
    {
        "m":"R",
        "r":0,
        "c":{
            "chats":[
                {"uuid":"ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒãƒ£ãƒƒãƒˆUUID", "name":"ãƒãƒ£ãƒƒãƒˆå", "timestamp":"Unixã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—"}
            ]
        }
    }
    ```

- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ
    ```json
    {
        "m":"R",
        "r":0,
        "c":{
            "messages":[
                {"uuid":"ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸UUID", "name":"åå‰", "content":"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹", "timestamp":"Unixã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—"}
            ]
        }
    }
    ```

- ãƒ”ã‚¢æƒ…å ±ã®å–å¾—
    ```json
    {
        "m":"R",
        "r":0,
        "c":{
            "peers":[
                {"natConeType":"NATã‚¿ã‚¤ãƒ—ï¼ˆRestricted Coneã¾ãŸã¯Full Coneï¼‰", "ip":"ãƒ”ã‚¢ã®ip", "port":"ãƒ”ã‚¢ã®port"}
            ]
        }
    }
    ```

- ãƒ”ã‚¢æƒ…å ±ã®ç™»éŒ²ï¼ˆãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ”ã‚¢ã‹ã‚‰è¿”ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰
    ```json
    {
        "m":"R",
        "r":0,
        "c":{}
    }
    ```

- ping
    ```json
    {
        "m":"R",
        "r":0,
        "c":{}
    }
    ```

#### çµæœãŒ0ä»¥å¤–ã®å ´åˆï¼ˆã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ï¼‰
ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```json
{
    "m":"R",
    "r":"ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆæ•´æ•°ã€1ä»¥å¤–ï¼‰",
    "c":{}
}
```
##### ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
###### 0ç³»åˆ—
- 1 :ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸ
- 2 :ä¸æ˜ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
- 3 :ã‚ãªãŸã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“
###### 10ç³»åˆ—ï¼ˆget/sendï¼‰
- 10 :æŒ‡å®šã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã¯å­˜åœ¨ã—ã¾ã›ã‚“
###### 20ï¼ˆsendï¼‰
- 20 :ã“ã‚Œä»¥ä¸ŠæŒ¿å…¥ã§ãã¾ã›ã‚“ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
###### 90ï¼ˆlocal errorï¼‰
- 90 : ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã‚‚ã†å¸°ã£ã¦ãã¾ã›ã‚“
### z
ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«é–¢ä¿‚ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç´ã¥ã‘ã‚‰ã‚Œã¾ã™ã€‚
ã“ã®å¼•æ•°ã¯æ–‡å­—åˆ—ãªã‚‰UUIDãªã©ã©ã®ã‚ˆã†ãªã‚‚ã®ã§ã‚‚ã‚ˆãã€ä»»æ„ã§ã™ã€‚(ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¤ã„ã¦ã„ã‚‹å ´åˆã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã‚‚ã¤ã„ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™)
#### ä¾‹ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
```json
{
    "m":"r",
    "t":"r",
    "d":"i",
    "a":{
        "natConeType":"Full Cone",
    },
    "z":"f79826df-27b1-9ee4-1b2d-c9ccf097137f"
}
```
#### ä¾‹ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰
```json
{
    "m":"R",
    "r":0,
    "c":{},
    "z":"f79826df-27b1-9ee4-1b2d-c9ccf097137f"
}
```